version: '3.3'
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:6.0.0
    labels:
      - traefik.backend=elasticsearch
      - traefik.port=9200
      - traefik.frontend.rule=Host:elasticsearch.docker.localhost
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ~/esdata:/usr/share/elasticsearch/data
  logstash:
    image: docker.elastic.co/logstash/logstash-oss:6.0.0
    command:
      --http.port 9600
    volumes:
      - ./logstash/pipeline/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    labels:
      - traefik.backend=logstash
      - traefik.port=9600
      - traefik.frontend.rule=Host:logstash.docker.localhost
  kibana:
    image: docker.elastic.co/kibana/kibana-oss:6.0.0
    labels:
      - traefik.backend=kibana
      - traefik.port=5601
      - traefik.frontend.rule=Host:kibana.docker.localhost
    ports:
      - 5601:5601
  logspout:
    restart: always
    build: ./logspout
    command: logstash+tcp://logstash:5000 # TODO Switch to UDP
    environment:
      - traefik.backend=logspout
      - traefik.port=80
      - traefik.frontend.rule=Host:logspout.docker.localhost
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  zookeeper: &zookeeper-defaults
    image: zookeeper:3.4.11
    ports:
      - 2181:2181

  mesos-master: &mesos-master-defaults
    image: mesosphere/mesos-master:1.4.0
    command:
      --hostname=mesos-master
      --quorum=1
      --work_dir=/var/lib/mesos/master
      --zk=zk://zookeeper:2181/mesos
    labels:
      - traefik.backend=mesos
      - traefik.port=5050
      - traefik.frontend.rule=Host:mesos.docker.localhost
    ports:
      - 5050:5050
    dns: 127.0.0.1
  marathon:
    image: mesosphere/marathon:v1.5.2
    command:
      --master local
      --zk zk://zookeeper:2181/marathon
      --http_port 7070
    privileged: true
    environment:
      - zookeeper_nodes_master=zk://zookeeper:2181/mesos
      - zookeeper_nodes=zk://zookeeper:2181/marathon
    labels:
      - traefik.backend=marathon
      - traefik.port=7070
      - traefik.frontend.rule=Host:marathon.docker.localhost
  traefik:
    image: traefik
    command:
      --web
      --docker --docker.domain=docker.localhost
      --logLevel=DEBUG
    ports:
      - 80:80
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /dev/null:/traefik.toml
    labels:
      - traefik.backend=traefik
      - traefik.port=8080
      - traefik.frontend.rule=Host:traefik.docker.localhost

  mesos-slave-1: &mesos-slave-defaults
    image: mesosphere/mesos-slave:1.4.0
    restart: always
    command:
      --master=zk://zookeeper:2181/mesos
      --no-systemd_enable_support
      --work_dir=/var/lib/mesos/agent
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # mesos-slave-2:
  #   <<: *mesos-slave-defaults

  # mesos-slave-3:
  #   <<: *mesos-slave-defaults

volumes:
  esdata1:
    driver: local
